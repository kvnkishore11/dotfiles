#!/bin/bash

# ═══════════════════════════════════════════════════════════════════════════════
#  SketchyBar - Polished Floating Islands + Catppuccin Mocha
#  Enhanced aesthetics with workspace app icons
# ═══════════════════════════════════════════════════════════════════════════════

CONFIG_DIR="$HOME/.config/sketchybar"
PLUGIN_DIR="$CONFIG_DIR/plugins"

source "$CONFIG_DIR/colors.sh"
source "$CONFIG_DIR/icons.sh"

# ═══════════════════════════════════════════════════════════════════════════════
#  BAR APPEARANCE
# ═══════════════════════════════════════════════════════════════════════════════

sketchybar --bar \
  position=top \
  height=36 \
  color=0x00000000 \
  margin=8 \
  y_offset=4 \
  padding_left=8 \
  padding_right=8 \
  notch_width=200 \
  display=all \
  shadow=off

# ═══════════════════════════════════════════════════════════════════════════════
#  DEFAULT VALUES - Enhanced Typography
# ═══════════════════════════════════════════════════════════════════════════════

default=(
  icon.font="Hack Nerd Font:Bold:15.0"
  icon.color=$TEXT
  icon.padding_left=10
  icon.padding_right=6

  label.font="Hack Nerd Font:Bold:13.0"
  label.color=$TEXT
  label.padding_left=6
  label.padding_right=10

  background.color=$ISLAND_COLOR
  background.corner_radius=12
  background.height=32
  background.padding_left=6
  background.padding_right=6

  popup.background.color=$BASE
  popup.background.corner_radius=12
  popup.background.border_width=1
  popup.background.border_color=$SURFACE1
)

sketchybar --default "${default[@]}"

# ═══════════════════════════════════════════════════════════════════════════════
#  LEFT - ACTIVE APP
# ═══════════════════════════════════════════════════════════════════════════════

sketchybar --add item front_app left \
  --set front_app \
    icon.drawing=on \
    icon.font="sketchybar-app-font:Regular:18.0" \
    icon.color=$LAVENDER \
    icon.padding_left=12 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$TEXT \
    label.padding_right=12 \
    background.color=$ISLAND_COLOR \
    background.corner_radius=12 \
    background.height=32 \
    script="$PLUGIN_DIR/front_app.sh" \
  --subscribe front_app front_app_switched

# ═══════════════════════════════════════════════════════════════════════════════
#  LEFT - WORKSPACES (Letters + App Icons)
# ═══════════════════════════════════════════════════════════════════════════════

sketchybar --add event aerospace_workspace_change

WORKSPACES=("1" "2" "3" "4" "5" "6" "7" "8" "9" "W" "C" "A")

for sid in "${WORKSPACES[@]}"; do
  sketchybar --add item space.$sid left \
    --set space.$sid \
      icon="$sid" \
      icon.font="Hack Nerd Font:Bold:14.0" \
      icon.color=$TEXT \
      icon.padding_left=8 \
      icon.padding_right=2 \
      label.font="sketchybar-app-font:Regular:14.0" \
      label.color=$SUBTEXT0 \
      label.padding_left=2 \
      label.padding_right=8 \
      label.drawing=off \
      background.color=$MAUVE \
      background.corner_radius=6 \
      background.height=24 \
      background.drawing=off \
      click_script="aerospace workspace $sid" \
    --subscribe space.$sid aerospace_workspace_change
done

# Workspace island bracket
sketchybar --add bracket spaces '/space\..*/' \
  --set spaces \
    background.color=$ISLAND_COLOR \
    background.corner_radius=12 \
    background.height=32

# Workspace updater
sketchybar --add item spaces_updater left \
  --set spaces_updater \
    drawing=off \
    script="$PLUGIN_DIR/aerospace_spaces.sh" \
  --subscribe spaces_updater aerospace_workspace_change

"$PLUGIN_DIR/aerospace_spaces.sh"

# ═══════════════════════════════════════════════════════════════════════════════
#  RIGHT - DATE/TIME
# ═══════════════════════════════════════════════════════════════════════════════

sketchybar --add item clock right \
  --set clock \
    icon=󰃭 \
    icon.font="Hack Nerd Font:Bold:15.0" \
    icon.color=$LAVENDER \
    icon.padding_left=12 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$TEXT \
    label.padding_right=12 \
    background.color=$ISLAND_COLOR \
    background.corner_radius=12 \
    background.height=32 \
    update_freq=30 \
    script="$PLUGIN_DIR/clock.sh"

# ═══════════════════════════════════════════════════════════════════════════════
#  RIGHT - SYSTEM STATS
# ═══════════════════════════════════════════════════════════════════════════════

# Memory
sketchybar --add item memory right \
  --set memory \
    icon=󰍛 \
    icon.font="Hack Nerd Font:Bold:17.0" \
    icon.color=$SAPPHIRE \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$SUBTEXT0 \
    label.padding_right=8 \
    background.drawing=off \
    update_freq=5 \
    script="$PLUGIN_DIR/memory.sh"

# CPU
sketchybar --add item cpu right \
  --set cpu \
    icon=󰻠 \
    icon.font="Hack Nerd Font:Bold:17.0" \
    icon.color=$GREEN \
    icon.padding_left=10 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$SUBTEXT0 \
    label.padding_right=6 \
    background.drawing=off \
    update_freq=3 \
    script="$PLUGIN_DIR/cpu.sh"

# Stats bracket
sketchybar --add bracket stats cpu memory \
  --set stats \
    background.color=$ISLAND_COLOR \
    background.corner_radius=12 \
    background.height=32

# ═══════════════════════════════════════════════════════════════════════════════
#  RIGHT - SYSTEM CONTROLS
# ═══════════════════════════════════════════════════════════════════════════════

# Mic
sketchybar --add item mic right \
  --set mic \
    icon=󰍬 \
    icon.font="Hack Nerd Font:Bold:17.0" \
    icon.color=$GREEN \
    icon.padding_left=8 \
    icon.padding_right=10 \
    label.drawing=off \
    background.drawing=off \
    script="$PLUGIN_DIR/mic.sh" \
    click_script="$PLUGIN_DIR/mic_click.sh"

# Battery
sketchybar --add item battery right \
  --set battery \
    icon.font="Hack Nerd Font:Bold:17.0" \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$SUBTEXT0 \
    label.padding_right=8 \
    background.drawing=off \
    update_freq=60 \
    script="$PLUGIN_DIR/battery.sh" \
  --subscribe battery system_woke power_source_change

# Volume
sketchybar --add item volume right \
  --set volume \
    icon=󰕾 \
    icon.font="Hack Nerd Font:Bold:17.0" \
    icon.color=$PEACH \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$SUBTEXT0 \
    label.padding_right=8 \
    background.drawing=off \
    script="$PLUGIN_DIR/volume.sh" \
    click_script="osascript -e 'set volume output muted not (output muted of (get volume settings))'" \
  --subscribe volume volume_change

# WiFi
sketchybar --add item wifi right \
  --set wifi \
    icon=󰤨 \
    icon.font="Hack Nerd Font:Bold:17.0" \
    icon.color=$SAPPHIRE \
    icon.padding_left=10 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$SUBTEXT0 \
    label.max_chars=10 \
    label.padding_right=8 \
    background.drawing=off \
    update_freq=30 \
    script="$PLUGIN_DIR/wifi.sh" \
    click_script="open 'x-apple.systempreferences:com.apple.preference.network'"

# System controls bracket
sketchybar --add bracket system wifi volume battery mic \
  --set system \
    background.color=$ISLAND_COLOR \
    background.corner_radius=12 \
    background.height=32

# ═══════════════════════════════════════════════════════════════════════════════
#  FINALIZE
# ═══════════════════════════════════════════════════════════════════════════════

sketchybar --hotload on
sketchybar --update
